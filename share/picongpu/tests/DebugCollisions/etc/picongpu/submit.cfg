# Copyright 2017-2021 Axel Huebl, Franz Poeschel, Marco Garten
#
# This file is part of PIConGPU.
#
# PIConGPU is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PIConGPU is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PIConGPU.
# If not, see <http://www.gnu.org/licenses/>.
#

##
## This configuration file is used by PIConGPU's TBG tool to create a
## batch script for PIConGPU runs. For a detailed description of PIConGPU
## configuration files including all available variables, see
##
##                      docs/TBG_macros.cfg
##


#################################
## Section: Required Variables ##
#################################

TBG_wallTime="4:00:00"

TBG_devices_x=2
TBG_devices_y=2
TBG_devices_z=1

# NOTE: Check density.param if the box dimensions change because the probe positions are hard-coded.
TBG_gridSize="96 2040 48"
TBG_gridDist="'48{2}' '4096{1},8192{1}' '48{1}'"
#TBG_steps="600"
TBG_steps="60000"

TBG_periodic="--periodic 1 0 1"


#################################
## Section: Optional Variables ##
#################################

# Adios I/O parameters from Piz Daint - hopefully ADIOS2 will do it here
#TBG_adios_agg="256"
#TBG_adios_ost="32"
#TBG_adios_transport_params="'stripe_count=4;stripe_size=1048576;block_size=1048576'"
#TBG_adios_compression="'blosc:threshold=2048,shuffle=bit,lvl=1,threads=10,compressor=zstd'"
#TBG_additional_params="--adios.aggregators !TBG_adios_agg                   \
#                       --adios.ost !TBG_adios_ost                           \
#                       --adios.transport-params !TBG_adios_transport_params \
#                       --adios.compression !TBG_adios_compression           \
#                       --adios.disable-meta 1"

# For large-sized outputs
TBG_ADIOS2_configuration="'{                             \
   \"adios2\": {                                         \
       \"dataset\": {                                    \
           \"operators\": [ {                            \
               \"type\": \"blosc\",                      \
               \"parameters\": {                         \
                   \"clevel\": \"7\"                     \
                   , \"compressor\": \"zstd\"            \
                   , \"doshuffle\": \"BLOSC_BITSHUFFLE\" \
               }                                         \
           } ]                                           \
       }                                                 \
       , \"engine\": {                                   \
           \"type\": \"file\"                            \
           , \"parameters\": {                           \
               \"BufferGrowthFactor\": \"1.1\"           \
               , \"InitialBufferSize\": \"45GB\"         \
               , \"AggregatorRatio\" : \"1\"             \
           }                                             \
       }                                                 \
   }                                                     \
}'"


# For very small outputs that shouldn't have many aggregators
TBG_ADIOS2_configuration_small="'{                       \
   \"adios2\": {                                         \
       \"dataset\": {                                    \
           \"operators\": [ {                            \
               \"type\": \"blosc\",                      \
               \"parameters\": {                         \
                   \"clevel\": \"7\"                     \
                   , \"compressor\": \"zstd\"            \
                   , \"doshuffle\": \"BLOSC_BITSHUFFLE\" \
               }                                         \
           } ]                                           \
       }                                                 \
       , \"engine\": {                                   \
           \"type\": \"file\"                            \
           , \"usesteps\": true                          \
           , \"parameters\": {                           \
               \"BufferGrowthFactor\": \"1.1\"           \
               , \"InitialBufferSize\": \"45GB\"         \
               , \"NumAggregators\" : \"384\"            \
           }                                             \
       }                                                 \
   }                                                     \
}'"


# Checkpoints
TBG_checkpoints="--checkpoint.period 43656:43656                                \
                 --checkpoint.file checkpoint                                   \
                 --checkpoint.backend openPMD                                   \
                 --checkpoint.restart.backend openPMD                           \
                 --checkpoint.restart.chunkSize 1000000                         \
                 --checkpoint.openPMD.json !TBG_ADIOS2_configuration            \
                 --checkpoint.openPMD.ext bp"
                 #--checkpoint.adios.aggregators !TBG_adios_agg                   \
                 #--checkpoint.adios.ost !TBG_adios_ost                           \
                 #--checkpoint.adios.transport-params !TBG_adios_transport_params \
                 #--checkpoint.adios.compression !TBG_adios_compression           \
                 #--checkpoint.adios.disable-meta 1"

# regular output
TBG_adios_fields="--openPMD.period 41886:41886,43656:43656,48377:48377   \
                  --openPMD.file simData_fields_all                      \
                  --openPMD.source 'fields_all'                          \
                  --openPMD.json !TBG_ADIOS2_configuration               \
                  --openPMD.ext bp"

TBG_adios_particles="--openPMD.period 41886:41886,43656:43656,48377:48377       \
                     --openPMD.file simData_particles_all                       \
                     --openPMD.source 'species_all'                             \
                     --openPMD.json !TBG_ADIOS2_configuration                   \
                     --openPMD.ext bp"

TBG_adios_protons="--openPMD.period 100                                         \
                   --openPMD.file simData_protons_yx                            \
                   --openPMD.source 'H_yxSlice'                                 \
                   --openPMD.json !TBG_ADIOS2_configuration_small               \
                   --openPMD.infix NULL                                         \
                   --openPMD.ext bp"

#TBG_probe_yx="--openPMD.period 100                                              \
#                     --openPMD.file simData_probe_yx                            \
#                     --openPMD.source 'probe_yxSlice'                           \
#                     --openPMD.json !TBG_ADIOS2_configuration_small             \
#                     --openPMD.infix NULL                                       \
#                     --openPMD.ext bp"

#TBG_probe_yz="--openPMD.period 100                                              \
#                     --openPMD.file simData_probe_yz                            \
#                     --openPMD.source 'probe_yzSlice'                           \
#                     --openPMD.json !TBG_ADIOS2_configuration_small             \
#                     --openPMD.infix NULL                                       \
#                     --openPMD.ext bp"

TBG_adios="!TBG_adios_fields    \
           !TBG_adios_particles"


# Count particles
TBG_countParticles="--e_macroParticlesCount.period 50  \
                    --H_macroParticlesCount.period 50  \
                    --C_macroParticlesCount.period 50  \
                    --O_macroParticlesCount.period 50"

# Create a particle-energy histogram [in keV]
TBG_e_HistogramTpl="--e_energyHistogram.period 50 --e_energyHistogram.binCount 2048    \
                    --e_energyHistogram.minEnergy 0 --e_energyHistogram.maxEnergy 500000"
TBG_e_histogram="!TBG_e_HistogramTpl --e_energyHistogram.filter all \
                 !TBG_e_HistogramTpl --e_energyHistogram.filter yxSlice \
                 !TBG_e_HistogramTpl --e_energyHistogram.filter yzSlice \
                 !TBG_e_HistogramTpl --e_energyHistogram.filter fwPinhole \
                 !TBG_e_HistogramTpl --e_energyHistogram.filter fwRCF"

TBG_H_HistogramTpl="--H_energyHistogram.period 50 --H_energyHistogram.binCount 2048    \
                    --H_energyHistogram.minEnergy 0 --H_energyHistogram.maxEnergy 300000"
TBG_H_histogram="!TBG_H_HistogramTpl --H_energyHistogram.filter all \
                 !TBG_H_HistogramTpl --H_energyHistogram.filter yxSlice \
                 !TBG_H_HistogramTpl --H_energyHistogram.filter yzSlice \
                 !TBG_H_HistogramTpl --H_energyHistogram.filter fwPinhole \
                 !TBG_H_HistogramTpl --H_energyHistogram.filter fwRCF"

TBG_C_HistogramTpl="--C_energyHistogram.period 50 --C_energyHistogram.binCount 2048    \
                    --C_energyHistogram.minEnergy 0 --C_energyHistogram.maxEnergy 1800000"
TBG_C_histogram="!TBG_C_HistogramTpl --C_energyHistogram.filter all \
                 !TBG_C_HistogramTpl --C_energyHistogram.filter yxSlice \
                 !TBG_C_HistogramTpl --C_energyHistogram.filter yzSlice \
                 !TBG_C_HistogramTpl --C_energyHistogram.filter fwPinhole \
                 !TBG_C_HistogramTpl --C_energyHistogram.filter fwRCF"

TBG_O_HistogramTpl="--O_energyHistogram.period 50 --O_energyHistogram.binCount 2048     \
                     --O_energyHistogram.minEnergy 0 --O_energyHistogram.maxEnergy 2200000"
TBG_O_histogram="!TBG_O_HistogramTpl --O_energyHistogram.filter all \
                  !TBG_O_HistogramTpl --O_energyHistogram.filter yxSlice \
                  !TBG_O_HistogramTpl --O_energyHistogram.filter yzSlice \
                  !TBG_O_HistogramTpl --O_energyHistogram.filter fwPinhole \
                  !TBG_O_HistogramTpl --O_energyHistogram.filter fwRCF"


# Particle Calorimeter for electrons
#TBG_e_calorimeter="--e_calorimeter.period 500 \
#                    --e_calorimeter.file e_cal \
#                    --e_calorimeter.filter all \
#                    --e_calorimeter.numBinsYaw 180 \
#                    --e_calorimeter.numBinsPitch 90 \
#                    --e_calorimeter.numBinsEnergy 1024 \
#                    --e_calorimeter.minEnergy 0 \
#                    --e_calorimeter.maxEnergy 250000 \
#                    --e_calorimeter.openingYaw 360 \
#                    --e_calorimeter.openingPitch 180"

# Particle Calorimeter for protons
#TBG_H_calorimeter="--H_calorimeter.period 500 \
#                    --H_calorimeter.file H_cal \
#                    --H_calorimeter.filter all \
#                    --H_calorimeter.numBinsYaw 180 \
#                    --H_calorimeter.numBinsPitch 90 \
#                    --H_calorimeter.numBinsEnergy 1024 \
#                    --H_calorimeter.minEnergy 1 \
#                    --H_calorimeter.maxEnergy 150000 \
#                    --H_calorimeter.openingYaw 360 \
#                    --H_calorimeter.openingPitch 180"


# electron phase space: in m_<species> c
TBG_e_PSypy="--e_phaseSpace.period 250 --e_phaseSpace.space y --e_phaseSpace.momentum py --e_phaseSpace.min -500.0 --e_phaseSpace.max 500.0 --e_phaseSpace.filter all"
TBG_e_PSxpy="--e_phaseSpace.period 250 --e_phaseSpace.space x --e_phaseSpace.momentum py --e_phaseSpace.min -500.0 --e_phaseSpace.max 500.0 --e_phaseSpace.filter all"
TBG_e_PSzpy="--e_phaseSpace.period 250 --e_phaseSpace.space z --e_phaseSpace.momentum py --e_phaseSpace.min -500.0 --e_phaseSpace.max 500.0 --e_phaseSpace.filter all"

TBG_e_PSypy_yxSlice="--e_phaseSpace.period 250,40000:48000:100 --e_phaseSpace.space y --e_phaseSpace.momentum py --e_phaseSpace.min -500.0 --e_phaseSpace.max 500.0 --e_phaseSpace.filter yxSlice"
TBG_e_PSypy_yzSlice="--e_phaseSpace.period 250,40000:48000:100 --e_phaseSpace.space y --e_phaseSpace.momentum py --e_phaseSpace.min -500.0 --e_phaseSpace.max 500.0 --e_phaseSpace.filter yzSlice"

TBG_e_PSypx="--e_phaseSpace.period 250 --e_phaseSpace.space y --e_phaseSpace.momentum px --e_phaseSpace.min -250.0 --e_phaseSpace.max 250.0 --e_phaseSpace.filter all"
TBG_e_PSxpx="--e_phaseSpace.period 250 --e_phaseSpace.space x --e_phaseSpace.momentum px --e_phaseSpace.min -250.0 --e_phaseSpace.max 250.0 --e_phaseSpace.filter all"
TBG_e_PSzpx="--e_phaseSpace.period 250 --e_phaseSpace.space z --e_phaseSpace.momentum px --e_phaseSpace.min -250.0 --e_phaseSpace.max 250.0 --e_phaseSpace.filter all"

TBG_e_PSypz="--e_phaseSpace.period 250 --e_phaseSpace.space y --e_phaseSpace.momentum pz --e_phaseSpace.min -250.0 --e_phaseSpace.max 250.0 --e_phaseSpace.filter all"
TBG_e_PSxpz="--e_phaseSpace.period 250 --e_phaseSpace.space x --e_phaseSpace.momentum pz --e_phaseSpace.min -250.0 --e_phaseSpace.max 250.0 --e_phaseSpace.filter all"
TBG_e_PSzpz="--e_phaseSpace.period 250 --e_phaseSpace.space z --e_phaseSpace.momentum pz --e_phaseSpace.min -250.0 --e_phaseSpace.max 250.0 --e_phaseSpace.filter all"

TBG_e_phaseSpace="!TBG_e_PSypy !TBG_e_PSxpy !TBG_e_PSzpy !TBG_e_PSypy_yxSlice !TBG_e_PSypy_yzSlice !TBG_e_PSypx !TBG_e_PSxpx !TBG_e_PSzpx !TBG_e_PSypz !TBG_e_PSxpz !TBG_e_PSzpz"

# proton phase space: in m_<species> c
TBG_H_PSypy="--H_phaseSpace.period 250 --H_phaseSpace.space y --H_phaseSpace.momentum py --H_phaseSpace.min -1.0 --H_phaseSpace.max 1.0 --H_phaseSpace.filter all"
TBG_H_PSxpy="--H_phaseSpace.period 250 --H_phaseSpace.space x --H_phaseSpace.momentum py --H_phaseSpace.min -1.0 --H_phaseSpace.max 1.0 --H_phaseSpace.filter all"
TBG_H_PSzpy="--H_phaseSpace.period 250 --H_phaseSpace.space z --H_phaseSpace.momentum py --H_phaseSpace.min -1.0 --H_phaseSpace.max 1.0 --H_phaseSpace.filter all"

TBG_H_PSypy_yxSlice="--H_phaseSpace.period 250,40000:48000:100 --H_phaseSpace.space y --H_phaseSpace.momentum py --H_phaseSpace.min -1.0 --H_phaseSpace.max 1.0 --H_phaseSpace.filter yxSlice"
TBG_H_PSypy_yzSlice="--H_phaseSpace.period 250,40000:48000:100 --H_phaseSpace.space y --H_phaseSpace.momentum py --H_phaseSpace.min -1.0 --H_phaseSpace.max 1.0 --H_phaseSpace.filter yzSlice"

TBG_H_PSypx="--H_phaseSpace.period 250 --H_phaseSpace.space y --H_phaseSpace.momentum px --H_phaseSpace.min -0.5 --H_phaseSpace.max 0.5 --H_phaseSpace.filter all"
TBG_H_PSxpx="--H_phaseSpace.period 250 --H_phaseSpace.space x --H_phaseSpace.momentum px --H_phaseSpace.min -0.5 --H_phaseSpace.max 0.5 --H_phaseSpace.filter all"
TBG_H_PSzpx="--H_phaseSpace.period 250 --H_phaseSpace.space z --H_phaseSpace.momentum px --H_phaseSpace.min -0.5 --H_phaseSpace.max 0.5 --H_phaseSpace.filter all"

TBG_H_PSypz="--H_phaseSpace.period 250 --H_phaseSpace.space y --H_phaseSpace.momentum pz --H_phaseSpace.min -0.5 --H_phaseSpace.max 0.5 --H_phaseSpace.filter all"
TBG_H_PSxpz="--H_phaseSpace.period 250 --H_phaseSpace.space x --H_phaseSpace.momentum pz --H_phaseSpace.min -0.5 --H_phaseSpace.max 0.5 --H_phaseSpace.filter all"
TBG_H_PSzpz="--H_phaseSpace.period 250 --H_phaseSpace.space z --H_phaseSpace.momentum pz --H_phaseSpace.min -0.5 --H_phaseSpace.max 0.5 --H_phaseSpace.filter all"

TBG_H_phaseSpace="!TBG_H_PSypy !TBG_H_PSxpy !TBG_H_PSzpy !TBG_H_PSypy_yxSlice !TBG_H_PSypy_yzSlice !TBG_H_PSypx !TBG_H_PSxpx !TBG_H_PSzpx !TBG_H_PSypz !TBG_H_PSxpz !TBG_H_PSzpz"

# carbon phase space: in m_<species> c
TBG_C_PSypy="--C_phaseSpace.period 250 --C_phaseSpace.space y --C_phaseSpace.momentum py --C_phaseSpace.min -0.6 --C_phaseSpace.max 0.6 --C_phaseSpace.filter all"
TBG_C_PSxpy="--C_phaseSpace.period 250 --C_phaseSpace.space x --C_phaseSpace.momentum py --C_phaseSpace.min -0.6 --C_phaseSpace.max 0.6 --C_phaseSpace.filter all"
TBG_C_PSzpy="--C_phaseSpace.period 250 --C_phaseSpace.space z --C_phaseSpace.momentum py --C_phaseSpace.min -0.6 --C_phaseSpace.max 0.6 --C_phaseSpace.filter all"

TBG_C_PSypy_yxSlice="--C_phaseSpace.period 250,40000:48000:100 --C_phaseSpace.space y --C_phaseSpace.momentum py --C_phaseSpace.min -0.6 --C_phaseSpace.max 0.6 --C_phaseSpace.filter yxSlice"
TBG_C_PSypy_yzSlice="--C_phaseSpace.period 250,40000:48000:100 --C_phaseSpace.space y --C_phaseSpace.momentum py --C_phaseSpace.min -0.6 --C_phaseSpace.max 0.6 --C_phaseSpace.filter yzSlice"

TBG_C_PSypx="--C_phaseSpace.period 250 --C_phaseSpace.space y --C_phaseSpace.momentum px --C_phaseSpace.min -0.3 --C_phaseSpace.max 0.3 --C_phaseSpace.filter all"
TBG_C_PSxpx="--C_phaseSpace.period 250 --C_phaseSpace.space x --C_phaseSpace.momentum px --C_phaseSpace.min -0.3 --C_phaseSpace.max 0.3 --C_phaseSpace.filter all"
TBG_C_PSzpx="--C_phaseSpace.period 250 --C_phaseSpace.space z --C_phaseSpace.momentum px --C_phaseSpace.min -0.3 --C_phaseSpace.max 0.3 --C_phaseSpace.filter all"

TBG_C_PSypz="--C_phaseSpace.period 250 --C_phaseSpace.space y --C_phaseSpace.momentum pz --C_phaseSpace.min -0.3 --C_phaseSpace.max 0.3 --C_phaseSpace.filter all"
TBG_C_PSxpz="--C_phaseSpace.period 250 --C_phaseSpace.space x --C_phaseSpace.momentum pz --C_phaseSpace.min -0.3 --C_phaseSpace.max 0.3 --C_phaseSpace.filter all"
TBG_C_PSzpz="--C_phaseSpace.period 250 --C_phaseSpace.space z --C_phaseSpace.momentum pz --C_phaseSpace.min -0.3 --C_phaseSpace.max 0.3 --C_phaseSpace.filter all"

TBG_C_phaseSpace="!TBG_C_PSypy !TBG_C_PSxpy !TBG_C_PSzpy !TBG_C_PSypy_yxSlice !TBG_C_PSypy_yzSlice !TBG_C_PSypx !TBG_C_PSxpx !TBG_C_PSzpx !TBG_C_PSypz !TBG_C_PSxpz !TBG_C_PSzpz"

# oxygen phase space: in m_<species> c
TBG_O_PSypy="--O_phaseSpace.period 250 --O_phaseSpace.space y --O_phaseSpace.momentum py --O_phaseSpace.min -0.6 --O_phaseSpace.max 0.6 --O_phaseSpace.filter all"
TBG_O_PSxpy="--O_phaseSpace.period 250 --O_phaseSpace.space x --O_phaseSpace.momentum py --O_phaseSpace.min -0.6 --O_phaseSpace.max 0.6 --O_phaseSpace.filter all"
TBG_O_PSzpy="--O_phaseSpace.period 250 --O_phaseSpace.space z --O_phaseSpace.momentum py --O_phaseSpace.min -0.6 --O_phaseSpace.max 0.6 --O_phaseSpace.filter all"

TBG_O_PSypy_yxSlice="--O_phaseSpace.period 250,40000:48000:100 --O_phaseSpace.space y --O_phaseSpace.momentum py --O_phaseSpace.min -0.6 --O_phaseSpace.max 0.6 --O_phaseSpace.filter yxSlice"
TBG_O_PSypy_yzSlice="--O_phaseSpace.period 250,40000:48000:100 --O_phaseSpace.space y --O_phaseSpace.momentum py --O_phaseSpace.min -0.6 --O_phaseSpace.max 0.6 --O_phaseSpace.filter yxSlice"

TBG_O_PSypx="--O_phaseSpace.period 250 --O_phaseSpace.space y --O_phaseSpace.momentum px --O_phaseSpace.min -0.3 --O_phaseSpace.max 0.3 --O_phaseSpace.filter all"
TBG_O_PSxpx="--O_phaseSpace.period 250 --O_phaseSpace.space x --O_phaseSpace.momentum px --O_phaseSpace.min -0.3 --O_phaseSpace.max 0.3 --O_phaseSpace.filter all"
TBG_O_PSzpx="--O_phaseSpace.period 250 --O_phaseSpace.space z --O_phaseSpace.momentum px --O_phaseSpace.min -0.3 --O_phaseSpace.max 0.3 --O_phaseSpace.filter all"

TBG_O_PSypz="--O_phaseSpace.period 250 --O_phaseSpace.space y --O_phaseSpace.momentum pz --O_phaseSpace.min -0.3 --O_phaseSpace.max 0.3 --O_phaseSpace.filter all"
TBG_O_PSxpz="--O_phaseSpace.period 250 --O_phaseSpace.space x --O_phaseSpace.momentum pz --O_phaseSpace.min -0.3 --O_phaseSpace.max 0.3 --O_phaseSpace.filter all"
TBG_O_PSzpz="--O_phaseSpace.period 250 --O_phaseSpace.space z --O_phaseSpace.momentum pz --O_phaseSpace.min -0.3 --O_phaseSpace.max 0.3 --O_phaseSpace.filter all"

TBG_O_phaseSpace="!TBG_O_PSypy !TBG_O_PSxpy !TBG_O_PSzpy !TBG_O_PSypy_yxSlice !TBG_O_PSypy_yxSlice !TBG_O_PSypx !TBG_O_PSxpx !TBG_O_PSzpx !TBG_O_PSypz !TBG_O_PSxpz !TBG_O_PSzpz"


# useful for heating tests
TBG_sumEnergy="--fields_energy.period 50 \
               --e_energy.period 50 --e_energy.filter all \
               --H_energy.period 50 --H_energy.filter all \
               --C_energy.period 50 --C_energy.filter all \
               --O_energy.period 50 --O_energy.filter all"


TBG_chargeConservation="--chargeConservation.period 100"

# PNG output
TBG_e_png="--e_png.period 1000 --e_png.axis xy --e_png.slicePoint 0.5 --e_png.folder e_png"

TBG_plugins="!TBG_sumEnergy !TBG_chargeConservation \
             !TBG_countParticles"

TBG_progress="-p 1"

#################################
## Section: Program Parameters ##
#################################

TBG_deviceDist="!TBG_devices_x !TBG_devices_y !TBG_devices_z"

TBG_programParams="-d !TBG_deviceDist           \
                   -g !TBG_gridSize --gridDist !TBG_gridDist            \
                   -s !TBG_steps                \
                   !TBG_periodic                \
                   !TBG_plugins                 \
                   !TBG_progress                \
                   --versionOnce"

# TOTAL number of devices
TBG_tasks="$(( TBG_devices_x * TBG_devices_y * TBG_devices_z ))"

"$TBG_cfgPath"/submitAction.sh
